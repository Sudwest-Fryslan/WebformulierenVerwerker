<?xml version="1.0" encoding="UTF-8"?>
<Module xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../FrankConfig.xsd">
    <Adapter name="InfoAction">
        <Receiver name="InfoAction">
            <JavaListener name="InfoAction" />
        </Receiver>

        <Pipeline>
            <Exits>
                <Exit name="SUCCESS" state="SUCCESS" />
                <Exit name="EXCEPTION" state="ERROR" />
            </Exits>

            <!-- Get Info from Corsa. -->
            <XsltPipe name="ConvertToAboutRequest" styleSheetName="xsl/Message2About.xsl"/>

            <SenderPipe name="sendToCorsa">
                <WebServiceSender methodType="POST" url="${corsa.url}" soapAction="http://bct.nl/About" soap="false" />
                <Forward name="success" path="ExtractInfo" />
                <Forward name="exception" path="buildErrorMsg" />
            </SenderPipe>

            <XsltPipe name="buildErrorMsg"
                styleSheetName="xsl/ParseNegativeHttpResult.xsl">
                <Forward name="success" path="EXCEPTION" />
            </XsltPipe>

            <XsltPipe name="ExtractInfo" styleSheetName="xsl/Response2Info.xsl">
                <Param name="stage" value="${dtap.stage}" />
                <Param name="userdomain" value="${USERDOMAIN}" />
                <Param name="username" value="${USERNAME}" />
                <Param name="serverType" value="${application.server.type}" />
                <Param name="osName" value="${os.name}" />
                <Param name="directory" value="${configurations.directory}" />
                <Forward name="success" path="Wrapper" />
                <Forward name="exception" path="EXCEPTION" />
            </XsltPipe>

            <SoapWrapperPipe name="Wrapper"/>  
        </Pipeline>
    </Adapter>
    
    <Adapter name="VersionAction">
        
        <Receiver name="VersionAction">
            <JavaListener name="VersionAction"/>
        </Receiver>
        <Pipeline>

            <Exits>
                <Exit name="SUCCESS" state="SUCCESS" />
                <Exit name="EXCEPTION" state="ERROR" />
            </Exits>

            <XsltPipe name="ExtractVersion" styleSheetName="xsl/Response2Version.xsl">
                <Param name="version" value="${instance.version}" />
                <Param name="versionDate_ddmmyyyy" value="${versionDate_ddmmyyyy}" />
                <Forward name="success" path="Wrapper" />
                <Forward name="exception" path="EXCEPTION" />
            </XsltPipe>

            <SoapWrapperPipe name="Wrapper"/>
        </Pipeline>
    </Adapter>


    <Adapter name="opslaanInkNatuurlijkPersoon">

		 <Receiver name="opslaanInkNatuurlijkPersoon">
            <JavaListener name="opslaanInkNatuurlijkPersoon"/>
        </Receiver>
        <Pipeline>

            <Exits>
                <Exit name="SUCCESS" state="SUCCESS" />
                <Exit name="EXCEPTION" state="ERROR" />
            </Exits>

            <XsltPipe name="ConvertToConnectRequest" styleSheetName="xsl/Message2Connect.xsl">
             	<Param name="username" authAlias="corsa-soap.connect" pattern="{username}"/>
             	<Param name="password" authAlias="corsa-soap.connect" pattern="{password}"/>
                <Param name="ConnectionID" value="${ConnectionID}"/>
            </XsltPipe>

            <SoapWrapperPipe name="WrapConnectRequest" />

            <WsdlXmlValidatorPipe name="ValidateConnectRequest" wsdl="Corsa72WS4j.xml"
                soapBody="Connect" throwException="true"/>

            <SenderPipe name="sendToCorsa1">
                <WebServiceSender methodType="POST" url="${corsa.url}" soapAction="http://bct.nl/Connect" soap="false" />
                <Forward name="success" path="Unwrapper1" />
                <Forward name="exception" path="buildErrorMsg1" />
            </SenderPipe>

            <XsltPipe name="buildErrorMsg1"
                styleSheetName="xsl/ParseNegativeHttpResult.xsl">
                <Forward name="success" path="EXCEPTION" />
            </XsltPipe>

            <SoapWrapperPipe name="Unwrapper1" direction="UNWRAP" removeOutputNamespaces="true">
                <Forward name="success" path="ConnectionSuccessCheck" />
                <Forward name="exception" path="EXCEPTION" />
            </SoapWrapperPipe>

            <XmlSwitchPipe
                name="ConnectionSuccessCheck"
                xpathExpression="ConnectResponse/ConnectResult = 'true'">
                <Forward name="true" path="ConvertToQueryRequest" />
                <Forward name="false" path="EXCEPTION" />
            </XmlSwitchPipe>

            <!-- Query to see if person exists -->
            <XsltPipe name="ConvertToQueryRequest" styleSheetName="xsl/Message2QueryPerson.xsl">
             	<Param name="afzenderbsn" xpathExpression="//afzenderbsn" sessionKey="originalMessage"/>
            </XsltPipe>

            <SoapWrapperPipe name="WrapQueryRequest" />

            <WsdlXmlValidatorPipe name="ValidateQueryRequest" wsdl="Corsa72WS4j.xml"
                soapBody="QueryExecute" throwException="true"/>

            <SenderPipe name="sendQueryToCorsa">
                <WebServiceSender methodType="POST" url="${corsa.url}" soapAction="http://bct.nl/QueryExecute" soap="false" />
                <Forward name="success" path="UnwrapQueryResponse" />
                <Forward name="exception" path="buildQueryErrorMsg" />
            </SenderPipe>

            <XsltPipe name="buildQueryErrorMsg"
                styleSheetName="xsl/ParseNegativeHttpResult.xsl">
                <Forward name="success" path="EXCEPTION" />
            </XsltPipe>

            <SoapWrapperPipe name="UnwrapQueryResponse" direction="UNWRAP" removeOutputNamespaces="true">
                <Forward name="success" path="RemoveResultTags" />
                <Forward name="exception" path="EXCEPTION" />
            </SoapWrapperPipe>

            <XsltPipe name="RemoveResultTags" xpathExpression="//QueryExecuteResult" />

            <Base64Pipe name="DecodeQueryResult"
				direction="DECODE"
                charset="UTF-8">
			</Base64Pipe>

            <!-- If person does not exist, create a person in Corsa. -->
            <XmlSwitchPipe
                name="QueryResultCheck"
                xpathExpression="boolean(//QueryExecResult/_x0024_id_x0024_)">
                <Forward name="true" path="GetSPNum" />
                <Forward name="false" path="ConvertToCreatePerson" />
            </XmlSwitchPipe>

            <XsltPipe name="GetSPNum" xpathExpression="//QueryExecResult/_x0024_id_x0024_"/>
            <PutInSessionPipe name="StoreSPNum" sessionKey="SPNum">
                <Forward name="success" path="ConvertToCreateDocument" />
            </PutInSessionPipe>

            <XsltPipe name="ConvertToCreatePerson" styleSheetName="xsl/Message2CreatePerson.xsl"
                getInputFromSessionKey="originalMessage">

                <Forward name="success" path="WrapCreatePersonRequest" />
                <Forward name="exception" path="EXCEPTION" />
            </XsltPipe>

            <SoapWrapperPipe name="WrapCreatePersonRequest" />

            <SenderPipe name="sendToCorsa2">
                <WebServiceSender methodType="POST" url="${corsa.url}"
                    soapAction="http://bct.nl/CreateMetaPerson" soap="false" />
                <Forward name="success" path="Unwrapper2" />
                <Forward name="exception" path="buildErrorMsg2" />
            </SenderPipe>

            <XsltPipe name="buildErrorMsg2"
                styleSheetName="xsl/ParseNegativeHttpResult.xsl">
                <Forward name="success" path="EXCEPTION" />
            </XsltPipe>

            <SoapWrapperPipe name="Unwrapper2" direction="UNWRAP" removeOutputNamespaces="true"
                storeResultInSessionKey="PersonData">
                <Forward name="success" path="CreatePersonResultCheck" />
                <Forward name="exception" path="EXCEPTION" />
            </SoapWrapperPipe>

            <XmlSwitchPipe
                name="CreatePersonResultCheck"
                xpathExpression="CreateMetaPersonResponse/CreateMetaPersonResult = 'true'">
                <Forward name="true" path="GetNewSPNum" />
                <Forward name="false" path="EXCEPTION" />
            </XmlSwitchPipe>

            <XsltPipe name="GetNewSPNum" xpathExpression="//NewObjectID"/>
            <PutInSessionPipe name="StoreNewSPNum" sessionKey="SPNum"/>
            
            <!-- If person is created, create a document in Corsa. -->
            <XsltPipe name="ConvertToCreateDocument" styleSheetName="xsl/Message2CreateDocument.xsl" getInputFromSessionKey="originalMessage">
            	<Param name="systemdate" pattern="{now, date,dd/MM/yyyy}"/>
                <Param name="PersoonID" sessionKey="SPNum"/>
            </XsltPipe>

            <SoapWrapperPipe name="WrapCreateDocumentRequest" />

            <WsdlXmlValidatorPipe name="ValidateCreateMetaDocumentRequest" wsdl="Corsa72WS4j.xml"
                soapBody="CreateMetaDocument" throwException="true"/>

            <SenderPipe name="sendToCorsa3">
                <WebServiceSender methodType="POST" url="${corsa.url}" soapAction="http://bct.nl/CreateMetaDocument" soap="false" />
                <Forward name="success" path="UnwrapAndStoreDocumentDetails" />
                <Forward name="exception" path="buildErrorMsg3" />
            </SenderPipe>
            
            <XsltPipe name="buildErrorMsg3"
                styleSheetName="xsl/ParseNegativeHttpResult.xsl">
                <Forward name="success" path="EXCEPTION" />
            </XsltPipe>

            <SoapWrapperPipe name="UnwrapAndStoreDocumentDetails" direction="UNWRAP" removeOutputNamespaces="true" storeResultInSessionKey="DocumentDetails"/>
            
            <XmlSwitchPipe
                name="DocumentDetailsCheck"
                xpathExpression="//CreateMetaDocumentResult = 'true'">
                <Forward name="true" path="ConvertToCreateFileVersion" />
                <Forward name="false" path="EXCEPTION" />
            </XmlSwitchPipe>
            
            <XsltPipe name="ConvertToCreateFileVersion" styleSheetName="xsl/Message2CreateFileVersion.xsl" getInputFromSessionKey="originalMessage">
            	<Param name="DocumentID" xpathExpression="//CreateMetaDocumentResponse/NewObjectID" sessionKey="DocumentDetails"/>
            </XsltPipe>

            <SoapWrapperPipe name="WrapCreateFileVersionRequest"/>

            <WsdlXmlValidatorPipe name="ValidateCreateFileVersionRequest" wsdl="Corsa72WS4j.xml"
                soapBody="CreateFileVersion" throwException="true"/>

            <SenderPipe name="sendToCorsa4">
                <WebServiceSender methodType="POST" url="${corsa.url}" soapAction="http://bct.nl/CreateFileVersion" soap="false" />
                <Forward name="success" path="RemoveXMLDeclaration" />
                <Forward name="exception" path="buildErrorMsg4" />
            </SenderPipe>

            <XsltPipe name="buildErrorMsg4"
                styleSheetName="xsl/ParseNegativeHttpResult.xsl">
                <Forward name="success" path="EXCEPTION" />
            </XsltPipe>

            <XsltPipe name="RemoveXMLDeclaration" omitXmlDeclaration="true" handleLexicalEvents="true" styleSheetName="xsl/Response2NoXML.xsl"/>

            <SoapWrapperPipe name="WrapResult" removeOutputNamespaces="true"  storeResultInSessionKey="FileVersionDetails"/>

            <XsltPipe name="ConvertToDisconnectRequest" styleSheetName="xsl/Message2Disconnect.xsl"/>

            <SoapWrapperPipe name="WrapDisconnectRequest" />

            <WsdlXmlValidatorPipe name="ValidateDisconnectRequest" wsdl="Corsa72WS4j.xml"
                soapBody="Disconnect" throwException="true"/>

            <SenderPipe name="SendDisconnectRequest">
                <WebServiceSender methodType="POST" url="${corsa.url}" soapAction="http://bct.nl/Disconnect" soap="false" />
                <Forward name="success" path="UnwrapDisconnectResponse" />
                <Forward name="exception" path="buildErrorMsg1" />
            </SenderPipe>

            <XsltPipe name="buildDisconnectErrorMsg"
                styleSheetName="xsl/ParseNegativeHttpResult.xsl">
                <Forward name="success" path="EXCEPTION" />
            </XsltPipe>

            <SoapWrapperPipe name="UnwrapDisconnectResponse" direction="UNWRAP" removeOutputNamespaces="true">
                <Forward name="success" path="DisconnectSuccessCheck" />
                <Forward name="exception" path="EXCEPTION" />
            </SoapWrapperPipe>

            <XmlSwitchPipe
                name="DisconnectSuccessCheck"
                xpathExpression="DisconnectResponse/DisconnectResult = 'true'">
                <Forward name="true" path="DateTime2Date" />
                <Forward name="false" path="EXCEPTION" />
            </XmlSwitchPipe>

            <XsltPipe name="DateTime2Date" styleSheetName="xsl/DateTime2Date.xsl" storeResultInSessionKey="StoreDate">
                <Param name="datetime" xpathExpression="current-dateTime()"/>
            </XsltPipe>

            <SenderPipe name="StoreVertrouwelijkheid" getInputFromSessionKey="originalMessage">
                <FixedQuerySender query="INSERT INTO VERTROUWELIJKHEID_CACHE VALUES (?, ?, ?) ON CONFLICT DO NOTHING;" />
                <Param name= "REGISTRATIENUMMER" sessionKey="DocumentDetails" xpathExpression="//NewObjectID"/>
                <Param name= "VERTROUWELIJKHEID" xpathExpression="//vertrouwelijkheid"/>
                <Param name= "STOREDATE" sessionKey="StoreDate"/>
            </SenderPipe>

            <EchoPipe name="ReturnResult" getInputFromSessionKey="FileVersionDetails"/>
        </Pipeline>
    </Adapter>

    <Adapter name="opslaanBijlage">
         <Receiver name="opslaanBijlage">
            <JavaListener name="opslaanBijlage"/>
        </Receiver>
        <Pipeline>
            <Exits>
                <Exit name="SUCCESS" state="SUCCESS" />
                <Exit name="EXCEPTION" state="ERROR" />
            </Exits>

            <XsltPipe name="ConvertToConnectRequest" styleSheetName="xsl/Message2Connect.xsl">
             	<Param name="username" authAlias="corsa-soap.connect" pattern="{username}"/>
             	<Param name="password" authAlias="corsa-soap.connect" pattern="{password}"/>
                <Param name="ConnectionID" value="${ConnectionID}"/>
            </XsltPipe>

            <SoapWrapperPipe name="WrapConnectRequest" soapNamespace="http://www.w3.org/2003/05/soap-envelope"/>

            <SenderPipe name="sendToCorsa1">
                <WebServiceSender methodType="POST" url="${corsa.url}" soapAction="http://bct.nl/Connect" soap="false" />
                <Forward name="success" path="Unwrapper1" />
                <Forward name="exception" path="buildErrorMsg1" />
            </SenderPipe>

            <XsltPipe name="buildErrorMsg1"
                styleSheetName="xsl/ParseNegativeHttpResult.xsl">
                <Forward name="success" path="EXCEPTION" />
            </XsltPipe>

            <SoapWrapperPipe name="Unwrapper1" direction="UNWRAP"  removeOutputNamespaces="true">
                <Forward name="success" path="ConnectionSuccessCheck" />
                <Forward name="exception" path="EXCEPTION" />
            </SoapWrapperPipe>

            <XmlSwitchPipe
                name="ConnectionSuccessCheck"
                xpathExpression="ConnectResponse/ConnectResult = 'true'">
                <Forward name="true" path="RequestVertrouwelijkheid" />
                <Forward name="false" path="EXCEPTION" />
            </XmlSwitchPipe>

            <SenderPipe name="RequestVertrouwelijkheid" getInputFromSessionKey="originalMessage">
                <FixedQuerySender queryType="SELECT"
                query="SELECT VERTROUWELIJKHEID FROM VERTROUWELIJKHEID_CACHE WHERE REGISTRATIENUMMER = ?" />
                <Param name= "REGISTRATIENUMMER" xpathExpression="//registratienummer"/>
            </SenderPipe>

            <XmlIfPipe name="CheckForVertrouwelijkheid" xpathExpression="count(//rowset/row) > 0">
                <Param name="Vertrouwelijkheid" sessionKey="Vertrouwelijkheid"/>
                <Forward name="then" path="GetVertrouwelijkheid" />
                <Forward name="else" path="EXCEPTION" />
            </XmlIfPipe>
            
            <XsltPipe name="GetVertrouwelijkheid" xpathExpression="//field[@name='VERTROUWELIJKHEID']"/>
            <PutInSessionPipe name="SetKeyVertrouwelijkheid" sessionKey="Vertrouwelijkheid"/>

            <XsltPipe name="ConvertToCreateMetaDocumentForBijlage" styleSheetName="xsl/Message2CreateMetaDocument.xsl" getInputFromSessionKey="originalMessage">
                <Param name="systemdate" pattern="{now, date,dd/MM/yyyy}"/>
                <Param name="Vertrouwelijkheid" sessionKey="Vertrouwelijkheid"/>
                <Forward name="success" path="WrapCreateMetaDocumentBijlageRequest" />
                <Forward name="exception" path="EXCEPTION" />
            </XsltPipe>

            <SoapWrapperPipe name="WrapCreateMetaDocumentBijlageRequest" />

            <SenderPipe name="sendToCorsa5">
                <WebServiceSender methodType="POST" url="${corsa.url}" soapAction="http://bct.nl/CreateMetaDocument" soap="false" />
                <Forward name="success" path="Wrapper5" />
                <Forward name="exception" path="buildErrorMsg5" />
            </SenderPipe>

            <XsltPipe name="buildErrorMsg5"
                styleSheetName="xsl/ParseNegativeHttpResult.xsl">
                <Forward name="success" path="EXCEPTION" />
            </XsltPipe>

            <SoapWrapperPipe name="Wrapper5" removeOutputNamespaces="true" storeResultInSessionKey="DocumentForBijlage">
                <Forward name="success" path="DocumentForBijlageCheck" />
                <Forward name="exception" path="EXCEPTION" />
            </SoapWrapperPipe>
            
            <XmlSwitchPipe
                name="DocumentForBijlageCheck"
                xpathExpression="//CreateMetaDocumentResult = 'true'">
                <Forward name="true" path="ConvertToCreateFileVersionForBijlage" />
                <Forward name="false" path="SUCCESS" />
            </XmlSwitchPipe>
                        
            <XsltPipe name="ConvertToCreateFileVersionForBijlage" styleSheetName="xsl/Message2CreateFileVersion.xsl" getInputFromSessionKey="originalMessage">
                <Param name="DocumentID" xpathExpression="//CreateMetaDocumentResponse/NewObjectID" sessionKey="DocumentForBijlage"/>
            </XsltPipe>

            <SoapWrapperPipe name="WrapCreateFileVersionRequest" soapNamespace="http://www.w3.org/2003/05/soap-envelope"/>

            <!-- <WsdlXmlValidatorPipe name="ValidateCreateFileVersionRequest" wsdl="Corsa72WS4j.xml"
                soapBody="CreateFileVersion" throwException="true"/> -->

            <SenderPipe name="sendToCorsa6">
                <WebServiceSender methodType="POST" url="${corsa.url}" soapAction="http://bct.nl/CreateFileVersion" soap="false" />
                <Forward name="success" path="Wrapper6" />
                <Forward name="exception" path="buildErrorMsg6" />
            </SenderPipe>

            <XsltPipe name="buildErrorMsg6"
                styleSheetName="xsl/ParseNegativeHttpResult.xsl">
                <Forward name="success" path="EXCEPTION" />
            </XsltPipe>

            <SoapWrapperPipe name="Wrapper6" removeOutputNamespaces="true">
                <Forward name="success" path="ConvertToModObjectRelation" />
                <Forward name="exception" path="EXCEPTION" />
            </SoapWrapperPipe>
            
            <XsltPipe name="ConvertToModObjectRelation" styleSheetName="xsl/Message2ModObjectRelation.xsl" getInputFromSessionKey="originalMessage">
                <Param name="systemdate" pattern="{now, date,dd/MM/yyyy}"/>
                <Param name="BijlageID" xpathExpression="//CreateMetaDocumentResponse/NewObjectID" sessionKey="DocumentForBijlage"/>
            </XsltPipe>

            <SoapWrapperPipe name="WrapModObjectRelationRequest" soapNamespace="http://www.w3.org/2003/05/soap-envelope"/>

            <!-- <WsdlXmlValidatorPipe name="ValidateModObjectRelationRequest" wsdl="Corsa72WS4j.xml"
                soapBody="ModObjectRelation" throwException="true"/> -->

            <SenderPipe name="sendToCorsa7">
                <WebServiceSender methodType="POST" url="${corsa.url}" soapAction="http://bct.nl/ModObjectRelation" soap="false" />
                <Forward name="success" path="ConvertToBijlageResponse" />
                <Forward name="exception" path="buildErrorMsg7" />
            </SenderPipe>
            
            <XsltPipe name="buildErrorMsg7"
                styleSheetName="xsl/ParseNegativeHttpResult.xsl">
                <Forward name="success" path="EXCEPTION" />
            </XsltPipe>

            <SoapWrapperPipe name="UnwrapModObjectRelationRequest" direction="UNWRAP"/>

            <XsltPipe name="ConvertToBijlageResponse" styleSheetName="xsl/Response2Bijlage.xsl" omitXmlDeclaration="true">
                <Param name="BijlageID" xpathExpression="//CreateMetaDocumentResponse/NewObjectID" sessionKey="DocumentForBijlage"/>
            </XsltPipe>

            <SoapWrapperPipe name="WrapResult" removeOutputNamespaces="true" storeResultInSessionKey="BijlageResults"/>

            <XsltPipe name="ConvertToDisconnectRequest" styleSheetName="xsl/Message2Disconnect.xsl"/>

            <SoapWrapperPipe name="WrapDisconnectRequest" />

            <WsdlXmlValidatorPipe name="ValidateDisconnectRequest" wsdl="Corsa72WS4j.xml"
                soapBody="Disconnect" throwException="true"/>

            <SenderPipe name="SendDisconnectRequest">
                <WebServiceSender methodType="POST" url="${corsa.url}" soapAction="http://bct.nl/Disconnect" soap="false" />
                <Forward name="success" path="UnwrapDisconnectResponse" />
                <Forward name="exception" path="buildErrorMsg1" />
            </SenderPipe>

            <XsltPipe name="buildDisconnectErrorMsg"
                styleSheetName="xsl/ParseNegativeHttpResult.xsl">
                <Forward name="success" path="EXCEPTION" />
            </XsltPipe>

            <SoapWrapperPipe name="UnwrapDisconnectResponse" direction="UNWRAP" removeOutputNamespaces="true">
                <Forward name="success" path="DisconnectSuccessCheck" />
                <Forward name="exception" path="EXCEPTION" />
            </SoapWrapperPipe>

            <XmlSwitchPipe
                name="DisconnectSuccessCheck"
                xpathExpression="DisconnectResponse/DisconnectResult = 'true'">
                <Forward name="true" path="ReturnResult" />
                <Forward name="false" path="EXCEPTION" />
            </XmlSwitchPipe>

            <EchoPipe name="ReturnResult" getInputFromSessionKey="BijlageResults"/>
        </Pipeline>
    </Adapter>
</Module>