<?xml version="1.0" encoding="UTF-8"?>
<Module xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:noNamespaceSchemaLocation="../FrankConfig.xsd">
    <Adapter name="InfoAction">
        <Receiver name="InfoAction">
            <JavaListener name="InfoAction" />
        </Receiver>

        <Pipeline>
            <Exits>
                <Exit name="SUCCESS" state="SUCCESS" />
                <Exit name="EXCEPTION" state="ERROR" />
            </Exits>

            <XsltPipe name="ConvertToAboutRequest" styleSheetName="xsl/Message2About.xsl"
                storeResultInSessionKey="corsaRequest" />

            <SenderPipe name="sendToCorsa">
                <WebServiceSender sharedResourceRef="SharedHttpSession"
                    url="${corsa.url}" soapAction="http://bct.nl/About" soap="false" timeout="12500" />
                <Forward name="success" path="ExtractInfo" />
                <Forward name="exception" path="isErrorXML" />
            </SenderPipe>

            <!-- Error Handling -->
            <IsXmlPipe name="isErrorXML">
                <Forward name="then" path="storeErrorResponse" />
                <Forward name="else" path="errorToXML" />
            </IsXmlPipe>

            <Text2XmlPipe xmlTag="error" name="errorToXML"></Text2XmlPipe>

            <PutInSessionPipe name="storeErrorResponse">
                <Param name="corsaResponse" />
            </PutInSessionPipe>

            <XsltPipe name="buildErrorMsg"
                styleSheetName="xsl/CreateErrorResponse.xsl"
                getInputFromFixedValue="&lt;dummy/&gt;">
                <Param name="corsaRequest" sessionKey="corsaRequest" />
                <Param name="corsaResponse" sessionKey="corsaResponse" />
                <Param name="corsaErrorMessage" xpathExpression="//LastError"
                    sessionKey="corsaResponse" defaultValue="No Error Message" />
                <Param name="soapAction" value="http://bct.nl/About" />
                <Forward name="success" path="EXCEPTION" />
            </XsltPipe>


            <XsltPipe name="ExtractInfo" styleSheetName="xsl/Response2Info.xsl">
                <Param name="stage" value="${dtap.stage}" />
                <Param name="userdomain" value="${USERDOMAIN}" />
                <Param name="username" value="${USERNAME}" />
                <Param name="serverType" value="${application.server.type}" />
                <Param name="osName" value="${os.name}" />
                <Param name="directory" value="${configurations.directory}" />
                <Param name="hipVersion" value="${instance.version}" />
                <Param name="wfvVersion" value="${configuration.version}" />
                <Param name="versionDate_ddmmyyyy" value="${versionDate_ddmmyyyy}" />
                <Param name="frameworkVersion" value="${application.version}" />
                <Param name="corsaUrl" value="${corsa.url}" />
                <Forward name="success" path="Wrapper" />
                <Forward name="exception" path="isErrorXML" />
            </XsltPipe>

            <SoapWrapperPipe name="Wrapper" />
        </Pipeline>
    </Adapter>

    <Adapter name="VersionAction">

        <Receiver name="VersionAction">
            <JavaListener name="VersionAction" />
        </Receiver>
        <Pipeline>

            <Exits>
                <Exit name="SUCCESS" state="SUCCESS" />
                <Exit name="EXCEPTION" state="ERROR" />
            </Exits>

            <XsltPipe name="ExtractVersion" styleSheetName="xsl/Response2Version.xsl">
                <Param name="version" value="${configuration.version}" />
                <Param name="versionDate_ddmmyyyy" value="${versionDate_ddmmyyyy}" />
                <Forward name="success" path="Wrapper" />
                <Forward name="exception" path="EXCEPTION" />
            </XsltPipe>

            <SoapWrapperPipe name="Wrapper" />
        </Pipeline>
    </Adapter>


    <Adapter name="opslaanInkNatuurlijkPersoon">

        <Receiver name="opslaanInkNatuurlijkPersoon">
            <JavaListener name="opslaanInkNatuurlijkPersoon" />
        </Receiver>
        <Pipeline>

            <Exits>
                <Exit name="SUCCESS" state="SUCCESS" />
                <Exit name="EXCEPTION" state="ERROR" />
            </Exits>

            <Locker objectId="opslaanInkNatuurlijkPersoon" numRetries="3" retryDelay="5000" />

            <XmlIfPipe name="StageCheck" xpathExpression="'${dtap.stage}' = 'TST'">
                <Forward name="then" path="ConvertToConnectRequest_Password" />
                <Forward name="else" path="ConvertToConnectRequest_NoPassword" />
            </XmlIfPipe>

            <XsltPipe name="ConvertToConnectRequest_NoPassword"
                styleSheetName="xsl/Message2Connect.xsl">
                <Param name="username" authAlias="corsa-soap.connect" pattern="{username}" />
                <Param name="ConnectionID" value="${ConnectionID}" />
                <Forward name="success" path="WrapConnectRequest" />
            </XsltPipe>

            <XsltPipe name="ConvertToConnectRequest_Password"
                styleSheetName="xsl/Message2Connect.xsl">
                <Param name="username" authAlias="corsa-soap.connect" pattern="{username}" />
                <Param name="password" authAlias="corsa-soap.connect" pattern="{password}" />
                <Param name="ConnectionID" value="${ConnectionID}" />
            </XsltPipe>

            <SoapWrapperPipe name="WrapConnectRequest" storeResultInSessionKey="corsaRequest" />

            <WsdlXmlValidatorPipe name="ValidateConnectRequest" wsdl="Corsa72WS4j.xml"
                soapBody="Connect" throwException="true" />

            <PutInSessionPipe name="storeConnectAction" sessionKey="RequestSoapAction"
                value="http://bct.nl/Connect" />

            <SenderPipe name="sendToCorsa1">
                <WebServiceSender sharedResourceRef="SharedHttpSession"
                    url="${corsa.url}" soapAction="http://bct.nl/Connect" soap="false"
                    timeout="12500" />
                <Forward name="success" path="Unwrapper1" />
                <Forward name="exception" path="isErrorXML" />
            </SenderPipe>

            <SoapWrapperPipe name="Unwrapper1" direction="UNWRAP" removeOutputNamespaces="true">
                <Forward name="success" path="ConnectionSuccessCheck" />
                <Forward name="exception" path="EXCEPTION" />
            </SoapWrapperPipe>

            <XmlSwitchPipe
                name="ConnectionSuccessCheck"
                xpathExpression="ConnectResponse/ConnectResult = 'true'">
                <Forward name="true" path="CheckForAfzender" />
                <Forward name="false" path="isErrorXML" />
            </XmlSwitchPipe>

            <XmlIfPipe name="CheckForAfzender" xpathExpression="string-length($afzenderbsn) > 1">
                <Param name="afzenderbsn" xpathExpression="//afzenderbsn"
                    sessionKey="originalMessage" />
                <Forward name="then" path="ConvertToQueryRequest" />
                <Forward name="else" path="ConvertToCreateDocument" />
            </XmlIfPipe>

            <!-- Query to see if person exists -->
            <XsltPipe name="ConvertToQueryRequest" styleSheetName="xsl/Message2QueryPerson.xsl">
                <Param name="afzenderbsn" xpathExpression="//afzenderbsn"
                    sessionKey="originalMessage" />
            </XsltPipe>

            <SoapWrapperPipe name="WrapQueryRequest" storeResultInSessionKey="corsaRequest" />

            <WsdlXmlValidatorPipe name="ValidateQueryRequest" wsdl="Corsa72WS4j.xml"
                soapBody="QueryExecute" throwException="true" />

            <PutInSessionPipe name="storeQueryExecuteAction" sessionKey="RequestSoapAction"
                value="http://bct.nl/QueryExecute" />

            <SenderPipe name="sendQueryToCorsa">
                <WebServiceSender sharedResourceRef="SharedHttpSession"
                    url="${corsa.url}" soapAction="http://bct.nl/QueryExecute" soap="false"
                    timeout="12500" />
                <Forward name="success" path="UnwrapQueryResponse" />
                <Forward name="exception" path="isErrorXML" />
            </SenderPipe>

            <SoapWrapperPipe name="UnwrapQueryResponse" direction="UNWRAP"
                removeOutputNamespaces="true">
                <Forward name="success" path="RemoveResultTags" />
                <Forward name="exception" path="EXCEPTION" />
            </SoapWrapperPipe>

            <XsltPipe name="RemoveResultTags" xpathExpression="//QueryExecuteResult" />

            <Base64Pipe name="DecodeQueryResult"
                direction="DECODE"
                charset="UTF-8">
            </Base64Pipe>

            <!-- If person does not exist, create a person in Corsa. -->
            <XmlSwitchPipe
                name="QueryResultCheck"
                xpathExpression="boolean(//QueryExecResult/_x0024_id_x0024_)">
                <Forward name="true" path="GetSPNum" />
                <Forward name="false" path="ConvertToCreatePerson" />
            </XmlSwitchPipe>

            <XsltPipe name="GetSPNum" xpathExpression="//QueryExecResult/_x0024_id_x0024_" />
            <PutInSessionPipe name="StoreSPNum" sessionKey="SPNum">
                <Forward name="success" path="ConvertToCreateDocument" />
            </PutInSessionPipe>

            <XsltPipe name="ConvertToCreatePerson" styleSheetName="xsl/Message2CreatePerson.xsl"
                getInputFromSessionKey="originalMessage">

                <Forward name="success" path="WrapCreatePersonRequest" />
                <Forward name="exception" path="EXCEPTION" />
            </XsltPipe>

            <SoapWrapperPipe name="WrapCreatePersonRequest" storeResultInSessionKey="corsaRequest" />

            <PutInSessionPipe name="storeCreateMetaPersonAction" sessionKey="RequestSoapAction"
                value="http://bct.nl/CreateMetaPerson" />

            <SenderPipe name="sendToCorsa2">
                <WebServiceSender sharedResourceRef="SharedHttpSession"
                    url="${corsa.url}" soapAction="http://bct.nl/CreateMetaPerson" soap="false"
                    timeout="12500" />
                <Forward name="success" path="Unwrapper2" />
                <Forward name="exception" path="isErrorXML" />
            </SenderPipe>

            <SoapWrapperPipe name="Unwrapper2" direction="UNWRAP" removeOutputNamespaces="true"
                storeResultInSessionKey="PersonData">
                <Forward name="success" path="CreatePersonResultCheck" />
                <Forward name="exception" path="EXCEPTION" />
            </SoapWrapperPipe>

            <XmlSwitchPipe
                name="CreatePersonResultCheck"
                xpathExpression="CreateMetaPersonResponse/CreateMetaPersonResult = 'true'">
                <Forward name="true" path="GetNewSPNum" />
                <Forward name="false" path="isErrorXML" />
            </XmlSwitchPipe>

            <XsltPipe name="GetNewSPNum" xpathExpression="//NewObjectID" />
            <PutInSessionPipe name="StoreNewSPNum" sessionKey="SPNum" />

            <!-- If person is created, create a document in Corsa. -->
            <XsltPipe name="ConvertToCreateDocument"
                styleSheetName="${WebformulierenVerwerker.CreateDocument-Stylesheet}"
                getInputFromSessionKey="originalMessage">
                <Param name="systemdate" pattern="{now, date,dd/MM/yyyy}" />
                <Param name="PersoonID" sessionKey="SPNum" />
            </XsltPipe>

            <SoapWrapperPipe name="WrapCreateDocumentRequest" storeResultInSessionKey="corsaRequest" />

            <WsdlXmlValidatorPipe name="ValidateCreateMetaDocumentRequest" wsdl="Corsa72WS4j.xml"
                soapBody="CreateMetaDocument" throwException="true" />

            <PutInSessionPipe name="storeCreateMetaDocumentAction" sessionKey="RequestSoapAction"
                value="http://bct.nl/CreateMetaDocument" />

            <SenderPipe name="sendToCorsa3">
                <WebServiceSender sharedResourceRef="SharedHttpSession"
                    url="${corsa.url}" soapAction="http://bct.nl/CreateMetaDocument" soap="false"
                    timeout="12500" />
                <Forward name="success" path="UnwrapAndStoreDocumentDetails" />
                <Forward name="exception" path="isErrorXML" />
            </SenderPipe>

            <SoapWrapperPipe name="UnwrapAndStoreDocumentDetails" direction="UNWRAP"
                removeOutputNamespaces="true" storeResultInSessionKey="DocumentDetails" />

            <XmlSwitchPipe
                name="DocumentDetailsCheck"
                xpathExpression="//CreateMetaDocumentResult = 'true'">
                <Forward name="true" path="ConvertToCreateFileVersion" />
                <Forward name="false" path="isErrorXML" />
            </XmlSwitchPipe>

            <XsltPipe name="ConvertToCreateFileVersion"
                styleSheetName="xsl/Message2CreateFileVersion.xsl"
                getInputFromSessionKey="originalMessage">
                <Param name="DocumentID" xpathExpression="//CreateMetaDocumentResponse/NewObjectID"
                    sessionKey="DocumentDetails" />
            </XsltPipe>

            <SoapWrapperPipe name="WrapCreateFileVersionRequest"
                storeResultInSessionKey="corsaRequest" />

            <WsdlXmlValidatorPipe name="ValidateCreateFileVersionRequest" wsdl="Corsa72WS4j.xml"
                soapBody="CreateFileVersion" throwException="true" />

            <PutInSessionPipe name="storeCreateFileVersionAction" sessionKey="RequestSoapAction"
                value="http://bct.nl/CreateFileVersion" />

            <SenderPipe name="sendToCorsa4">
                <WebServiceSender sharedResourceRef="SharedHttpSession"
                    url="${corsa.url}" soapAction="http://bct.nl/CreateFileVersion" soap="false"
                    timeout="12500" />
                <Forward name="success" path="CreateFileVersionCheck" />
                <Forward name="exception" path="isErrorXML" />
            </SenderPipe>

            <XmlSwitchPipe
                name="CreateFileVersionCheck"
                xpathExpression="//CreateFileVersionResult = 'true'">
                <Forward name="true" path="RemoveXMLDeclaration" />
                <Forward name="false" path="isErrorXML" />
            </XmlSwitchPipe>

            <XsltPipe name="RemoveXMLDeclaration" omitXmlDeclaration="true"
                handleLexicalEvents="true" styleSheetName="xsl/Response2NoXML.xsl" />

            <SoapWrapperPipe name="WrapResult" removeOutputNamespaces="true"
                storeResultInSessionKey="FileVersionDetails" />

            <XmlIfPipe name="IfDossierId" getInputFromSessionKey="originalMessage"
                xpathExpression="//dossiercode != ''">
                <Forward name="then" path="ConvertToModObjectRelationDossier" />
                <Forward name="else" path="ConvertToDisconnectRequest" />
            </XmlIfPipe>

            <!-- Handle Dossier -->
            <XsltPipe name="ConvertToModObjectRelationDossier"
                styleSheetName="xsl/Message2ModObjectRelationDossier.xsl"
                getInputFromSessionKey="originalMessage">
                <Param name="systemdate" pattern="{now, date,dd/MM/yyyy}" />
                <Param name="DossierID" xpathExpression="//dossiercode" />
                <Param name="Registratienummer"
                    xpathExpression="//opslaanInkNatuurlijkPersoonResult"
                    sessionKey="FileVersionDetails" />
            </XsltPipe>

            <SoapWrapperPipe name="WrapModObjectRelationDossierRequest"
                soapNamespace="http://www.w3.org/2003/05/soap-envelope"
                storeResultInSessionKey="corsaRequest" />

            <PutInSessionPipe name="storeModObjectRelationAction" sessionKey="RequestSoapAction"
                value="http://bct.nl/ModObjectRelation" />

            <SenderPipe name="Send_ModObjectRelationDossier_Request">
                <WebServiceSender sharedResourceRef="SharedHttpSession"
                    url="${corsa.url}" soapAction="http://bct.nl/ModObjectRelation" soap="false" />
                <!-- Cannot check if Dossier exists and should not interrupt user, so ignore errors. -->
                <Forward name="success" path="ConvertToDisconnectRequest" />
                <Forward name="exception" path="ConvertToDisconnectRequest" />
            </SenderPipe>

            <XsltPipe name="ConvertToDisconnectRequest" getInputFromFixedValue="&lt;Default/>"
                styleSheetName="xsl/Message2Disconnect.xsl" />

            <SoapWrapperPipe name="WrapDisconnectRequest" storeResultInSessionKey="corsaRequest" />

            <WsdlXmlValidatorPipe name="ValidateDisconnectRequest" wsdl="Corsa72WS4j.xml"
                soapBody="Disconnect" throwException="true" />

            <PutInSessionPipe name="storeDisconnectAction" sessionKey="RequestSoapAction"
                value="http://bct.nl/Disconnect" />

            <SenderPipe name="SendDisconnectRequest">
                <WebServiceSender sharedResourceRef="SharedHttpSession"
                    url="${corsa.url}" soapAction="http://bct.nl/Disconnect" soap="false"
                    timeout="12500" />
                <Forward name="success" path="DisconnectSuccessCheck" />
                <Forward name="exception" path="storeErrorResponse" />
            </SenderPipe>

            <XmlSwitchPipe
                name="DisconnectSuccessCheck"
                xpathExpression="//DisconnectResponse/DisconnectResult = 'true'">
                <Forward name="true" path="DateTime2Date" />
                <Forward name="false" path="isErrorXML" />
            </XmlSwitchPipe>

            <XsltPipe name="DateTime2Date" styleSheetName="xsl/DateTime2Date.xsl"
                storeResultInSessionKey="StoreDate">
                <Param name="datetime" xpathExpression="current-dateTime()" />
            </XsltPipe>

            <XmlIfPipe name="CheckStage" getInputFromFixedValue="&lt;staticValue/>"
                xpathExpression="'${dtap.stage}' = 'LOC'">
                <Forward name="then" path="StoreVertrouwelijkheidLocal" />
                <Forward name="else" path="StoreVertrouwelijkheid" />
            </XmlIfPipe>

            <SenderPipe name="StoreVertrouwelijkheidLocal" getInputFromSessionKey="originalMessage">
                <FixedQuerySender
                    query="
                MERGE INTO INFO_CACHE AS target
                USING (
                    VALUES
                        (?, ?, ?, ?, ?)
                ) AS source (REGISTRATIENUMMER, VERTROUWELIJKHEID, AFZENDER, ONDERWERP, STOREDATE)
                ON target.REGISTRATIENUMMER = source.REGISTRATIENUMMER
                WHEN NOT MATCHED THEN
                    INSERT (REGISTRATIENUMMER, VERTROUWELIJKHEID, AFZENDER, ONDERWERP, STOREDATE)
                    VALUES (source.REGISTRATIENUMMER, source.VERTROUWELIJKHEID, source.AFZENDER, source.ONDERWERP, source.STOREDATE);" />
                <Param name="REGISTRATIENUMMER" sessionKey="DocumentDetails"
                    xpathExpression="//NewObjectID" />
                <Param name="VERTROUWELIJKHEID" xpathExpression="//vertrouwelijkheid" />
                <Param name="AFZENDER" xpathExpression="//behandelaarnaam" />
                <Param name="ONDERWERP" xpathExpression="//onderwerp" />
                <Param name="STOREDATE" type="DATE" sessionKey="StoreDate" />
                <Forward name="success" path="ReturnResult" />
            </SenderPipe>

            <SenderPipe name="StoreVertrouwelijkheid" getInputFromSessionKey="originalMessage">
                <FixedQuerySender
                    query="INSERT INTO INFO_CACHE VALUES (?, ?, ?, ?, ?) ON CONFLICT DO NOTHING;" />
                <Param name="REGISTRATIENUMMER" sessionKey="DocumentDetails"
                    xpathExpression="//NewObjectID" />
                <Param name="VERTROUWELIJKHEID" xpathExpression="//vertrouwelijkheid" />
                <Param name="AFZENDER" xpathExpression="//behandelaarnaam" />
                <Param name="ONDERWERP" xpathExpression="//onderwerp" />
                <Param name="STOREDATE" type="DATE" sessionKey="StoreDate" />
                <Forward name="success" path="ReturnResult" />
            </SenderPipe>

            <EchoPipe name="ReturnResult" getInputFromSessionKey="FileVersionDetails">
                <Forward name="success" path="SUCCESS" />
            </EchoPipe>


            <!-- Error Handling -->
            <IsXmlPipe name="isErrorXML">
                <Forward name="then" path="storeErrorResponse" />
                <Forward name="else" path="errorToXML" />
            </IsXmlPipe>

            <Text2XmlPipe xmlTag="error" name="errorToXML"></Text2XmlPipe>

            <PutInSessionPipe name="storeErrorResponse">
                <Param name="corsaResponse" />
                <Forward name="success" path="buildErrorMsg" />
            </PutInSessionPipe>

            <XsltPipe name="buildErrorMsg"
                styleSheetName="xsl/CreateErrorResponse.xsl"
                getInputFromFixedValue="&lt;dummy/&gt;">
                <Param name="corsaRequest" sessionKey="corsaRequest" />
                <Param name="corsaResponse" sessionKey="corsaResponse" />
                <Param name="corsaErrorMessage" xpathExpression="//LastError"
                    sessionKey="corsaResponse" defaultValue="No Error Message" />
                <Param name="soapAction" sessionKey="RequestSoapAction" />
                <Forward name="success" path="EXCEPTION" />
            </XsltPipe>
        </Pipeline>
    </Adapter>

    <Adapter name="opslaanBijlage">
        <Receiver name="opslaanBijlage">
            <JavaListener name="opslaanBijlage" />
        </Receiver>
        <Pipeline>
            <Exits>
                <Exit name="SUCCESS" state="SUCCESS" />
                <Exit name="EXCEPTION" state="ERROR" />
            </Exits>

            <Locker objectId="opslaanBijlage" numRetries="3" retryDelay="5000" />

            <XmlIfPipe name="StageCheck" xpathExpression="'${dtap.stage}' = 'TST'">
                <Forward name="then" path="ConvertToConnectRequest_Password" />
                <Forward name="else" path="ConvertToConnectRequest_NoPassword" />
            </XmlIfPipe>

            <XsltPipe name="ConvertToConnectRequest_NoPassword"
                styleSheetName="xsl/Message2Connect.xsl">
                <Param name="username" authAlias="corsa-soap.connect" pattern="{username}" />
                <Param name="ConnectionID" value="${ConnectionID}" />
                <Forward name="success" path="WrapConnectRequest" />
            </XsltPipe>

            <XsltPipe name="ConvertToConnectRequest_Password"
                styleSheetName="xsl/Message2Connect.xsl">
                <Param name="username" authAlias="corsa-soap.connect" pattern="{username}" />
                <Param name="password" authAlias="corsa-soap.connect" pattern="{password}" />
                <Param name="ConnectionID" value="${ConnectionID}" />
            </XsltPipe>

            <SoapWrapperPipe name="WrapConnectRequest"
                soapNamespace="http://www.w3.org/2003/05/soap-envelope"
                storeResultInSessionKey="corsaRequest" />

            <PutInSessionPipe name="storeConnectAction" sessionKey="RequestSoapAction"
                value="http://bct.nl/Connect" />

            <SenderPipe name="sendToCorsa1">
                <WebServiceSender sharedResourceRef="SharedHttpSession"
                    url="${corsa.url}" soapAction="http://bct.nl/Connect" soap="false"
                    timeout="20000" />
                <Forward name="success" path="Unwrapper1" />
                <Forward name="exception" path="isErrorXML" />
            </SenderPipe>

            <SoapWrapperPipe name="Unwrapper1" direction="UNWRAP" removeOutputNamespaces="true">
                <Forward name="success" path="ConnectionSuccessCheck" />
                <Forward name="exception" path="EXCEPTION" />
            </SoapWrapperPipe>

            <XmlSwitchPipe
                name="ConnectionSuccessCheck"
                xpathExpression="ConnectResponse/ConnectResult = 'true'">
                <Forward name="true" path="RequestInfo" />
                <Forward name="false" path="isErrorXML" />
            </XmlSwitchPipe>

            <SenderPipe name="RequestInfo" getInputFromSessionKey="originalMessage"
                storeResultInSessionKey="QueryResponse">
                <FixedQuerySender queryType="SELECT"
                    query="SELECT VERTROUWELIJKHEID, AFZENDER, ONDERWERP FROM INFO_CACHE WHERE REGISTRATIENUMMER = ?" />
                <Param name="REGISTRATIENUMMER" xpathExpression="//registratienummer" />
            </SenderPipe>

            <XmlIfPipe name="CheckForVertrouwelijkheid" xpathExpression="count(//rowset/row) > 0">
                <Param name="Vertrouwelijkheid" sessionKey="Vertrouwelijkheid" />
                <Forward name="then" path="GetVertrouwelijkheid" />
                <Forward name="else" path="EXCEPTION" />
            </XmlIfPipe>

            <XsltPipe name="GetVertrouwelijkheid"
                xpathExpression="//rowset//field[@name='VERTROUWELIJKHEID']" />
            <PutInSessionPipe name="SetKeyVertrouwelijkheid" sessionKey="Vertrouwelijkheid" />

            <XsltPipe name="GetAfzender" xpathExpression="//rowset//field[@name='AFZENDER']"
                getInputFromSessionKey="QueryResponse" />
            <PutInSessionPipe name="SetKeyAfzender" sessionKey="Afzender" />

            <XsltPipe name="GetOnderwerp" xpathExpression="//rowset//field[@name='ONDERWERP']"
                getInputFromSessionKey="QueryResponse" />
            <PutInSessionPipe name="SetKeyOnderwerp" sessionKey="Onderwerp" />

            <XsltPipe name="ConvertToCreateMetaDocumentForBijlage"
                styleSheetName="xsl/Message2CreateMetaDocument.xsl"
                getInputFromSessionKey="originalMessage">
                <Param name="systemdate" pattern="{now, date,dd/MM/yyyy}" />
                <Param name="Vertrouwelijkheid" sessionKey="Vertrouwelijkheid" />
                <Param name="Afzender" sessionKey="Afzender" />
                <Param name="Onderwerp" sessionKey="Onderwerp" />
                <Forward name="success" path="WrapCreateMetaDocumentBijlageRequest" />
                <Forward name="exception" path="EXCEPTION" />
            </XsltPipe>

            <SoapWrapperPipe name="WrapCreateMetaDocumentBijlageRequest"
                storeResultInSessionKey="corsaRequest" />

            <PutInSessionPipe name="storeCreateMetaDocumentAction" sessionKey="RequestSoapAction"
                value="http://bct.nl/CreateMetaDocument" />

            <SenderPipe name="sendToCorsa5">
                <WebServiceSender sharedResourceRef="SharedHttpSession"
                    url="${corsa.url}" soapAction="http://bct.nl/CreateMetaDocument" soap="false"
                    timeout="12500" />
                <Forward name="success" path="Wrapper5" />
                <Forward name="exception" path="isErrorXML" />
            </SenderPipe>

            <SoapWrapperPipe name="Wrapper5" removeOutputNamespaces="true"
                storeResultInSessionKey="DocumentForBijlage">
                <Forward name="success" path="DocumentForBijlageCheck" />
                <Forward name="exception" path="EXCEPTION" />
            </SoapWrapperPipe>

            <XmlSwitchPipe
                name="DocumentForBijlageCheck"
                xpathExpression="//CreateMetaDocumentResult = 'true'">
                <Forward name="true" path="ConvertToCreateFileVersionForBijlage" />
                <Forward name="false" path="isErrorXML" />
            </XmlSwitchPipe>

            <XsltPipe name="ConvertToCreateFileVersionForBijlage"
                styleSheetName="xsl/Message2CreateFileVersionBijlage.xsl"
                getInputFromSessionKey="originalMessage"
                storeResultInSessionKey="corsaRequest">
                <Param name="DocumentID" xpathExpression="//CreateMetaDocumentResponse/NewObjectID"
                    sessionKey="DocumentForBijlage" />
            </XsltPipe>

            <PutInSessionPipe name="storeCreateFileVersionAction" sessionKey="RequestSoapAction"
                value="http://bct.nl/CreateFileVersion" />

            <SenderPipe name="sendToCorsa6">
                <WebServiceSender sharedResourceRef="SharedHttpSession"
                    url="${corsa.url}" soapAction="http://bct.nl/CreateFileVersion" soap="false"
                    timeout="12500" />
                <Forward name="success" path="Wrapper6" />
                <Forward name="exception" path="isErrorXML" />
            </SenderPipe>

            <SoapWrapperPipe name="Wrapper6" removeOutputNamespaces="true">
                <Forward name="success" path="ConvertToModObjectRelation" />
                <Forward name="exception" path="EXCEPTION" />
            </SoapWrapperPipe>

            <XsltPipe name="ConvertToModObjectRelation"
                styleSheetName="xsl/Message2ModObjectRelation.xsl"
                getInputFromSessionKey="originalMessage">
                <Param name="systemdate" pattern="{now, date,dd/MM/yyyy}" />
                <Param name="BijlageID" xpathExpression="//CreateMetaDocumentResponse/NewObjectID"
                    sessionKey="DocumentForBijlage" />
            </XsltPipe>

            <SoapWrapperPipe name="WrapModObjectRelationRequest"
                soapNamespace="http://www.w3.org/2003/05/soap-envelope"
                storeResultInSessionKey="corsaRequest" />

            <PutInSessionPipe name="storeModObjectRelationAction" sessionKey="RequestSoapAction"
                value="http://bct.nl/ModObjectRelation" />

            <SenderPipe name="sendToCorsa7">
                <WebServiceSender sharedResourceRef="SharedHttpSession"
                    url="${corsa.url}" soapAction="http://bct.nl/ModObjectRelation" soap="false"
                    timeout="12500" />
                <Forward name="success" path="UnwrapModObjectRelationRequest" />
                <Forward name="exception" path="isErrorXML" />
            </SenderPipe>

            <SoapWrapperPipe name="UnwrapModObjectRelationRequest" direction="UNWRAP" />

            <XmlSwitchPipe
                name="ModObjectRelationCheck"
                xpathExpression="//ModObjectRelationResult = 'true'">
                <Forward name="true" path="ConvertToBijlageResponse" />
                <Forward name="false" path="isErrorXML" />
            </XmlSwitchPipe>

            <XsltPipe name="ConvertToBijlageResponse" styleSheetName="xsl/Response2Bijlage.xsl"
                omitXmlDeclaration="true">
                <Param name="BijlageID" xpathExpression="//CreateMetaDocumentResponse/NewObjectID"
                    sessionKey="DocumentForBijlage" />
            </XsltPipe>

            <SoapWrapperPipe name="WrapResult" removeOutputNamespaces="true"
                storeResultInSessionKey="BijlageResults" />

            <XsltPipe name="ConvertToDisconnectRequest" styleSheetName="xsl/Message2Disconnect.xsl" />

            <SoapWrapperPipe name="WrapDisconnectRequest" storeResultInSessionKey="corsaRequest" />

            <WsdlXmlValidatorPipe name="ValidateDisconnectRequest" wsdl="Corsa72WS4j.xml"
                soapBody="Disconnect" throwException="true" />

            <PutInSessionPipe name="storeDisconnectAction" sessionKey="RequestSoapAction"
                value="http://bct.nl/Disconnect" />

            <SenderPipe name="SendDisconnectRequest">
                <WebServiceSender sharedResourceRef="SharedHttpSession"
                    url="${corsa.url}" soapAction="http://bct.nl/Disconnect" soap="false"
                    timeout="12500" />
                <Forward name="success" path="DisconnectSuccessCheck" />
                <Forward name="exception" path="storeErrorResponse" />
            </SenderPipe>

            <XmlSwitchPipe
                name="DisconnectSuccessCheck"
                xpathExpression="//DisconnectResponse/DisconnectResult = 'true'">
                <Forward name="true" path="ReturnResult" />
                <Forward name="false" path="isErrorXML" />
            </XmlSwitchPipe>

            <EchoPipe name="ReturnResult" getInputFromSessionKey="BijlageResults">
                <Forward name="success" path="SUCCESS" />
            </EchoPipe>


            <!-- Error Handling -->
            <IsXmlPipe name="isErrorXML">
                <Forward name="then" path="storeErrorResponse" />
                <Forward name="else" path="errorToXML" />
            </IsXmlPipe>

            <Text2XmlPipe xmlTag="error" name="errorToXML"></Text2XmlPipe>

            <PutInSessionPipe name="storeErrorResponse">
                <Param name="corsaResponse" />
                <Forward name="success" path="buildErrorMsg" />
            </PutInSessionPipe>

            <XsltPipe name="buildErrorMsg"
                styleSheetName="xsl/CreateErrorResponse.xsl"
                getInputFromFixedValue="&lt;dummy/&gt;">
                <Param name="corsaRequest" sessionKey="corsaRequest" />
                <Param name="corsaResponse" sessionKey="corsaResponse" />
                <Param name="corsaErrorMessage" xpathExpression="//LastError"
                    sessionKey="corsaResponse" defaultValue="No Error Message" />
                <Param name="soapAction" sessionKey="RequestSoapAction" />
                <Forward name="success" path="EXCEPTION" />
            </XsltPipe>
        </Pipeline>
    </Adapter>


    <Adapter name="opslaanInkNietNatuurlijkPersoon">

        <Receiver name="opslaanInkNietNatuurlijkPersoon">
            <JavaListener name="opslaanInkNietNatuurlijkPersoon" />
        </Receiver>
        <Pipeline>

            <Exits>
                <Exit name="SUCCESS" state="SUCCESS" />
                <Exit name="EXCEPTION" state="ERROR" />
            </Exits>

            <Locker objectId="opslaanInkNietNatuurlijkPersoon" numRetries="3" retryDelay="5000" />

            <XmlIfPipe name="StageCheck" xpathExpression="'${dtap.stage}' = 'TST'">
                <Forward name="then" path="ConvertToConnectRequest_Password" />
                <Forward name="else" path="ConvertToConnectRequest_NoPassword" />
            </XmlIfPipe>

            <XsltPipe name="ConvertToConnectRequest_NoPassword"
                styleSheetName="xsl/Message2Connect.xsl">
                <Param name="username" authAlias="corsa-soap.connect" pattern="{username}" />
                <Param name="ConnectionID" value="${ConnectionID}" />
                <Forward name="success" path="WrapConnectRequest" />
            </XsltPipe>

            <XsltPipe name="ConvertToConnectRequest_Password"
                styleSheetName="xsl/Message2Connect.xsl">
                <Param name="username" authAlias="corsa-soap.connect" pattern="{username}" />
                <Param name="password" authAlias="corsa-soap.connect" pattern="{password}" />
                <Param name="ConnectionID" value="${ConnectionID}" />
            </XsltPipe>

            <SoapWrapperPipe name="WrapConnectRequest" storeResultInSessionKey="corsaRequest" />

            <WsdlXmlValidatorPipe name="ValidateConnectRequest" wsdl="Corsa72WS4j.xml"
                soapBody="Connect" throwException="true" />

            <PutInSessionPipe name="storeConnectAction" sessionKey="RequestSoapAction"
                value="http://bct.nl/Connect" />

            <SenderPipe name="sendToCorsa1">
                <WebServiceSender sharedResourceRef="SharedHttpSession"
                    url="${corsa.url}" soapAction="http://bct.nl/Connect" soap="false"
                    timeout="20000" />
                <Forward name="success" path="Unwrapper1" />
                <Forward name="exception" path="isErrorXML" />
            </SenderPipe>

            <SoapWrapperPipe name="Unwrapper1" direction="UNWRAP" removeOutputNamespaces="true">
                <Forward name="success" path="ConnectionSuccessCheck" />
                <Forward name="exception" path="EXCEPTION" />
            </SoapWrapperPipe>

            <XmlSwitchPipe
                name="ConnectionSuccessCheck"
                xpathExpression="ConnectResponse/ConnectResult = 'true'">
                <Forward name="true" path="ConvertToQueryRequest" />
                <Forward name="false" path="isErrorXML" />
            </XmlSwitchPipe>

            <XmlIfPipe name="CheckForAfzender" xpathExpression="string-length($afzenderkvk) > 1">
                <Param name="afzenderkvk" xpathExpression="//afzenderkvk"
                    sessionKey="originalMessage" />
                <Forward name="then" path="ConvertToQueryRequest" />
                <Forward name="else" path="ConvertToCreateCompany" />
            </XmlIfPipe>

            <!-- Query to see if organisation exists -->
            <XsltPipe name="ConvertToQueryRequest" styleSheetName="xsl/Message2QueryCompany.xsl">
                <Param name="afzenderkvk" xpathExpression="//afzenderkvk"
                    sessionKey="originalMessage" />
            </XsltPipe>

            <SoapWrapperPipe name="WrapQueryRequest" storeResultInSessionKey="corsaRequest" />

            <WsdlXmlValidatorPipe name="ValidateQueryRequest" wsdl="Corsa72WS4j.xml"
                soapBody="QueryExecute" throwException="true" />

            <PutInSessionPipe name="storeQueryExecuteAction" sessionKey="RequestSoapAction"
                value="http://bct.nl/QueryExecute" />

            <SenderPipe name="sendQueryToCorsa">
                <WebServiceSender sharedResourceRef="SharedHttpSession"
                    url="${corsa.url}" soapAction="http://bct.nl/QueryExecute" soap="false"
                    timeout="12500" />
                <Forward name="success" path="UnwrapQueryResponse" />
                <Forward name="exception" path="isErrorXML" />
            </SenderPipe>

            <SoapWrapperPipe name="UnwrapQueryResponse" direction="UNWRAP"
                removeOutputNamespaces="true">
                <Forward name="success" path="RemoveResultTags" />
                <Forward name="exception" path="EXCEPTION" />
            </SoapWrapperPipe>

            <XsltPipe name="RemoveResultTags" xpathExpression="//QueryExecuteResult" />

            <Base64Pipe name="DecodeQueryResult"
                direction="DECODE"
                charset="UTF-8">
            </Base64Pipe>

            <!-- If company does not exist, create a company in Corsa. -->
            <XmlSwitchPipe
                name="QueryResultCheck"
                xpathExpression="boolean(//QueryExecResult/_x0024_id_x0024_)">
                <Forward name="true" path="GetONum" />
                <Forward name="false" path="ConvertToCreateCompany" />
            </XmlSwitchPipe>

            <XsltPipe name="GetONum" xpathExpression="//QueryExecResult/_x0024_id_x0024_" />
            <PutInSessionPipe name="SetONum" sessionKey="ONum">
                <Forward name="success" path="ConvertToCreateDocument" />
            </PutInSessionPipe>

            <XsltPipe name="ConvertToCreateCompany" styleSheetName="xsl/Message2CreateCompany.xsl"
                getInputFromSessionKey="originalMessage">

                <Forward name="success" path="WrapCreateCompanyRequest" />
                <Forward name="exception" path="EXCEPTION" />
            </XsltPipe>

            <SoapWrapperPipe name="WrapCreateCompanyRequest" storeResultInSessionKey="corsaRequest" />

            <PutInSessionPipe name="storeCreateMetaOrganisationAction"
                sessionKey="RequestSoapAction" value="http://bct.nl/CreateMetaOrganisation" />

            <SenderPipe name="sendToCorsa2">
                <WebServiceSender sharedResourceRef="SharedHttpSession"
                    url="${corsa.url}" soapAction="http://bct.nl/CreateMetaOrganisation"
                    soap="false" timeout="12500" />
                <Forward name="success" path="Unwrapper2" />
                <Forward name="exception" path="isErrorXML" />
            </SenderPipe>

            <SoapWrapperPipe name="Unwrapper2" direction="UNWRAP" removeOutputNamespaces="true"
                storeResultInSessionKey="PersonData">
                <Forward name="success" path="CreateCompanyResultCheck" />
                <Forward name="exception" path="EXCEPTION" />
            </SoapWrapperPipe>

            <XmlSwitchPipe
                name="CreateCompanyResultCheck"
                xpathExpression="CreateMetaOrganisationResponse/CreateMetaOrganisationResult = 'true'">
                <Forward name="true" path="GetNewONum" />
                <Forward name="false" path="isErrorXML" />
            </XmlSwitchPipe>

            <XsltPipe name="GetNewONum" xpathExpression="//NewObjectID" />
            <PutInSessionPipe name="StoreNewONum" sessionKey="ONum" />

            <!-- If person is created, create a document in Corsa. -->
            <XsltPipe name="ConvertToCreateDocument"
                styleSheetName="${WebformulierenVerwerker.CreateDocumentCompany-Stylesheet}"
                getInputFromSessionKey="originalMessage">
                <Param name="systemdate" pattern="{now, date,dd/MM/yyyy}" />
                <Param name="ONum" sessionKey="ONum" />
            </XsltPipe>

            <SoapWrapperPipe name="WrapCreateDocumentRequest" storeResultInSessionKey="corsaRequest" />

            <WsdlXmlValidatorPipe name="ValidateCreateMetaDocumentRequest" wsdl="Corsa72WS4j.xml"
                soapBody="CreateMetaDocument" throwException="true" />

            <PutInSessionPipe name="storeCreateMetaDocumentAction" sessionKey="RequestSoapAction"
                value="http://bct.nl/CreateMetaDocument" />

            <SenderPipe name="sendToCorsa3">
                <WebServiceSender sharedResourceRef="SharedHttpSession"
                    url="${corsa.url}" soapAction="http://bct.nl/CreateMetaDocument" soap="false"
                    timeout="12500" />
                <Forward name="success" path="UnwrapAndStoreDocumentDetails" />
                <Forward name="exception" path="isErrorXML" />
            </SenderPipe>

            <SoapWrapperPipe name="UnwrapAndStoreDocumentDetails" direction="UNWRAP"
                removeOutputNamespaces="true" storeResultInSessionKey="DocumentDetails" />

            <XmlSwitchPipe
                name="DocumentDetailsCheck"
                xpathExpression="//CreateMetaDocumentResult = 'true'">
                <Forward name="true" path="ConvertToCreateFileVersion" />
                <Forward name="false" path="isErrorXML" />
            </XmlSwitchPipe>

            <XsltPipe name="ConvertToCreateFileVersion"
                styleSheetName="xsl/Message2CreateFileVersion.xsl"
                getInputFromSessionKey="originalMessage">
                <Param name="DocumentID" xpathExpression="//CreateMetaDocumentResponse/NewObjectID"
                    sessionKey="DocumentDetails" />
            </XsltPipe>

            <SoapWrapperPipe name="WrapCreateFileVersionRequest"
                storeResultInSessionKey="corsaRequest" />

            <WsdlXmlValidatorPipe name="ValidateCreateFileVersionRequest" wsdl="Corsa72WS4j.xml"
                soapBody="CreateFileVersion" throwException="true" />

            <PutInSessionPipe name="storeCreateFileVersionAction" sessionKey="RequestSoapAction"
                value="http://bct.nl/CreateFileVersion" />

            <SenderPipe name="sendToCorsa4">
                <WebServiceSender sharedResourceRef="SharedHttpSession"
                    url="${corsa.url}" soapAction="http://bct.nl/CreateFileVersion" soap="false"
                    timeout="12500" />
                <Forward name="success" path="CreateFileVersionCheck" />
                <Forward name="exception" path="isErrorXML" />
            </SenderPipe>

            <XmlSwitchPipe
                name="CreateFileVersionCheck"
                xpathExpression="//CreateFileVersionResult = 'true'">
                <Forward name="true" path="RemoveXMLDeclaration" />
                <Forward name="false" path="isErrorXML" />
            </XmlSwitchPipe>

            <XsltPipe name="RemoveXMLDeclaration" omitXmlDeclaration="true"
                handleLexicalEvents="true" styleSheetName="xsl/Response2NoXMLCompany.xsl" />

            <SoapWrapperPipe name="WrapResult" removeOutputNamespaces="true"
                storeResultInSessionKey="FileVersionDetails" />

            <XmlIfPipe name="IfDossierId" getInputFromSessionKey="originalMessage"
                xpathExpression="//dossiercode != ''">
                <Forward name="then" path="ConvertToModObjectRelationDossier" />
                <Forward name="else" path="ConvertToDisconnectRequest" />
            </XmlIfPipe>

            <!-- Handle Dossier -->
            <XsltPipe name="ConvertToModObjectRelationDossier"
                styleSheetName="xsl/Message2ModObjectRelationDossier.xsl"
                getInputFromSessionKey="originalMessage">
                <Param name="systemdate" pattern="{now, date,dd/MM/yyyy}" />
                <Param name="DossierID" xpathExpression="//dossiercode" />
                <Param name="Registratienummer"
                    xpathExpression="//opslaanInkNietNatuurlijkPersoonResult"
                    sessionKey="FileVersionDetails" />
            </XsltPipe>

            <SoapWrapperPipe name="WrapModObjectRelationDossierRequest"
                soapNamespace="http://www.w3.org/2003/05/soap-envelope"
                storeResultInSessionKey="corsaRequest" />

            <PutInSessionPipe name="storeModObjectRelationAction" sessionKey="RequestSoapAction"
                value="http://bct.nl/ModObjectRelation" />

            <SenderPipe name="Send_ModObjectRelationDossier_Request">
                <WebServiceSender sharedResourceRef="SharedHttpSession"
                    url="${corsa.url}" soapAction="http://bct.nl/ModObjectRelation" soap="false" />
                <!-- Cannot check if Dossier exists and should not interrupt user, so ignore errors. -->
                <Forward name="success" path="ConvertToDisconnectRequest" />
                <Forward name="exception" path="ConvertToDisconnectRequest" />
            </SenderPipe>

            <XsltPipe name="ConvertToDisconnectRequest" styleSheetName="xsl/Message2Disconnect.xsl" />

            <SoapWrapperPipe name="WrapDisconnectRequest" storeResultInSessionKey="corsaRequest" />

            <WsdlXmlValidatorPipe name="ValidateDisconnectRequest" wsdl="Corsa72WS4j.xml"
                soapBody="Disconnect" throwException="true" />

            <PutInSessionPipe name="storeDisconnectAction" sessionKey="RequestSoapAction"
                value="http://bct.nl/Disconnect" />

            <SenderPipe name="SendDisconnectRequest">
                <WebServiceSender sharedResourceRef="SharedHttpSession"
                    url="${corsa.url}" soapAction="http://bct.nl/Disconnect" soap="false"
                    timeout="12500" />
                <Forward name="success" path="DisconnectSuccessCheck" />
                <Forward name="exception" path="storeErrorResponse" />
            </SenderPipe>

            <XmlSwitchPipe
                name="DisconnectSuccessCheck"
                xpathExpression="//DisconnectResponse/DisconnectResult = 'true'">
                <Forward name="true" path="DateTime2Date" />
                <Forward name="false" path="isErrorXML" />
            </XmlSwitchPipe>

            <XsltPipe name="DateTime2Date" styleSheetName="xsl/DateTime2Date.xsl"
                storeResultInSessionKey="StoreDate">
                <Param name="datetime" xpathExpression="current-dateTime()" />
            </XsltPipe>

            <XmlIfPipe name="CheckStage" getInputFromFixedValue="&lt;staticValue/>"
                xpathExpression="'${dtap.stage}' = 'LOC'">
                <Forward name="then" path="StoreVertrouwelijkheidLocal" />
                <Forward name="else" path="StoreVertrouwelijkheid" />
            </XmlIfPipe>

            <SenderPipe name="StoreVertrouwelijkheidLocal" getInputFromSessionKey="originalMessage">
                <FixedQuerySender
                    query="
                MERGE INTO INFO_CACHE AS target
                USING (
                    VALUES
                        (?, ?, ?, ?, ?)
                ) AS source (REGISTRATIENUMMER, VERTROUWELIJKHEID, AFZENDER, ONDERWERP, STOREDATE)
                ON target.REGISTRATIENUMMER = source.REGISTRATIENUMMER
                WHEN NOT MATCHED THEN
                    INSERT (REGISTRATIENUMMER, VERTROUWELIJKHEID, AFZENDER, ONDERWERP, STOREDATE)
                    VALUES (source.REGISTRATIENUMMER, source.VERTROUWELIJKHEID, source.AFZENDER, source.ONDERWERP, source.STOREDATE);" />
                <Param name="REGISTRATIENUMMER" sessionKey="DocumentDetails"
                    xpathExpression="//NewObjectID" />
                <Param name="VERTROUWELIJKHEID" xpathExpression="//vertrouwelijkheid" />
                <Param name="AFZENDER" xpathExpression="//behandelaarnaam" />
                <Param name="ONDERWERP" xpathExpression="//onderwerp" />
                <Param name="STOREDATE" type="DATE" sessionKey="StoreDate" />
                <Forward name="success" path="ReturnResult" />
            </SenderPipe>

            <SenderPipe name="StoreVertrouwelijkheid" getInputFromSessionKey="originalMessage">
                <FixedQuerySender
                    query="INSERT INTO INFO_CACHE VALUES (?, ?, ?, ?, ?) ON CONFLICT DO NOTHING;" />
                <Param name="REGISTRATIENUMMER" sessionKey="DocumentDetails"
                    xpathExpression="//NewObjectID" />
                <Param name="VERTROUWELIJKHEID" xpathExpression="//vertrouwelijkheid" />
                <Param name="AFZENDER" xpathExpression="//behandelaarnaam" />
                <Param name="ONDERWERP" xpathExpression="//onderwerp" />
                <Param name="STOREDATE" type="DATE" sessionKey="StoreDate" />
                <Forward name="success" path="ReturnResult" />
            </SenderPipe>

            <EchoPipe name="ReturnResult" getInputFromSessionKey="FileVersionDetails">
                <Forward name="success" path="SUCCESS" />
            </EchoPipe>


            <!-- Error Handling -->
            <IsXmlPipe name="isErrorXML">
                <Forward name="then" path="storeErrorResponse" />
                <Forward name="else" path="errorToXML" />
            </IsXmlPipe>

            <Text2XmlPipe xmlTag="error" name="errorToXML"></Text2XmlPipe>

            <PutInSessionPipe name="storeErrorResponse">
                <Param name="corsaResponse" />
                <Forward name="success" path="buildErrorMsg" />
            </PutInSessionPipe>

            <XsltPipe name="buildErrorMsg"
                styleSheetName="xsl/CreateErrorResponse.xsl"
                getInputFromFixedValue="&lt;dummy/&gt;">
                <Param name="corsaRequest" sessionKey="corsaRequest" />
                <Param name="corsaResponse" sessionKey="corsaResponse" />
                <Param name="corsaErrorMessage" xpathExpression="//LastError"
                    sessionKey="corsaResponse" defaultValue="No Error Message" />
                <Param name="soapAction" sessionKey="RequestSoapAction" />
                <Forward name="success" path="EXCEPTION" />
            </XsltPipe>
        </Pipeline>
    </Adapter>

    <Adapter name="opslaanInk">

        <Receiver name="opslaanInk">
            <JavaListener name="opslaanInk" />
        </Receiver>
        <Pipeline>

            <Exits>
                <Exit name="SUCCESS" state="SUCCESS" />
                <Exit name="EXCEPTION" state="ERROR" />
            </Exits>

            <Locker objectId="opslaanInk" numRetries="3" retryDelay="5000" />

            <XmlIfPipe name="StageCheck" xpathExpression="'${dtap.stage}' = 'TST'">
                <Forward name="then" path="ConvertToConnectRequest_Password" />
                <Forward name="else" path="ConvertToConnectRequest_NoPassword" />
            </XmlIfPipe>

            <XsltPipe name="ConvertToConnectRequest_NoPassword"
                styleSheetName="xsl/Message2Connect.xsl">
                <Param name="username" authAlias="corsa-soap.connect" pattern="{username}" />
                <Param name="ConnectionID" value="${ConnectionID}" />
                <Forward name="success" path="WrapConnectRequest" />
            </XsltPipe>

            <XsltPipe name="ConvertToConnectRequest_Password"
                styleSheetName="xsl/Message2Connect.xsl">
                <Param name="username" authAlias="corsa-soap.connect" pattern="{username}" />
                <Param name="password" authAlias="corsa-soap.connect" pattern="{password}" />
                <Param name="ConnectionID" value="${ConnectionID}" />
            </XsltPipe>

            <SoapWrapperPipe name="WrapConnectRequest" storeResultInSessionKey="corsaRequest" />

            <WsdlXmlValidatorPipe name="ValidateConnectRequest" wsdl="Corsa72WS4j.xml"
                soapBody="Connect" throwException="true" />

            <PutInSessionPipe name="storeConnectAction" sessionKey="RequestSoapAction"
                value="http://bct.nl/Connect" />

            <SenderPipe name="sendToCorsa1">
                <WebServiceSender sharedResourceRef="SharedHttpSession"
                    url="${corsa.url}" soapAction="http://bct.nl/Connect" soap="false"
                    timeout="12500" />
                <Forward name="success" path="Unwrapper1" />
                <Forward name="exception" path="isErrorXML" />
            </SenderPipe>

            <SoapWrapperPipe name="Unwrapper1" direction="UNWRAP" removeOutputNamespaces="true">
                <Forward name="success" path="ConnectionSuccessCheck" />
                <Forward name="exception" path="EXCEPTION" />
            </SoapWrapperPipe>

            <XmlSwitchPipe
                name="ConnectionSuccessCheck"
                xpathExpression="ConnectResponse/ConnectResult = 'true'">
                <Forward name="true" path="ConvertToCreateDocument" />
                <Forward name="false" path="isErrorXML" />
            </XmlSwitchPipe>

            <!-- If person is created, create a document in Corsa. -->
            <XsltPipe name="ConvertToCreateDocument" styleSheetName="xsl/Message2CreateDocument.xsl"
                getInputFromSessionKey="originalMessage">
                <Param name="systemdate" pattern="{now, date,dd/MM/yyyy}" />
                <Param name="PersoonID" sessionKey="SPNum" />
            </XsltPipe>

            <SoapWrapperPipe name="WrapCreateDocumentRequest" storeResultInSessionKey="corsaRequest" />

            <WsdlXmlValidatorPipe name="ValidateCreateMetaDocumentRequest" wsdl="Corsa72WS4j.xml"
                soapBody="CreateMetaDocument" throwException="true" />

            <PutInSessionPipe name="storeCreateMetaDocumentAction" sessionKey="RequestSoapAction"
                value="http://bct.nl/CreateMetaDocument" />

            <SenderPipe name="sendToCorsa3">
                <WebServiceSender sharedResourceRef="SharedHttpSession"
                    url="${corsa.url}" soapAction="http://bct.nl/CreateMetaDocument" soap="false"
                    timeout="12500" />
                <Forward name="success" path="UnwrapAndStoreDocumentDetails" />
                <Forward name="exception" path="isErrorXML" />
            </SenderPipe>

            <SoapWrapperPipe name="UnwrapAndStoreDocumentDetails" direction="UNWRAP"
                removeOutputNamespaces="true" storeResultInSessionKey="DocumentDetails" />

            <XmlSwitchPipe
                name="DocumentDetailsCheck"
                xpathExpression="//CreateMetaDocumentResult = 'true'">
                <Forward name="true" path="ConvertToCreateFileVersion" />
                <Forward name="false" path="isErrorXML" />
            </XmlSwitchPipe>

            <XsltPipe name="ConvertToCreateFileVersion"
                styleSheetName="xsl/Message2CreateFileVersion.xsl"
                getInputFromSessionKey="originalMessage">
                <Param name="DocumentID" xpathExpression="//CreateMetaDocumentResponse/NewObjectID"
                    sessionKey="DocumentDetails" />
            </XsltPipe>

            <SoapWrapperPipe name="WrapCreateFileVersionRequest"
                storeResultInSessionKey="corsaRequest" />

            <WsdlXmlValidatorPipe name="ValidateCreateFileVersionRequest" wsdl="Corsa72WS4j.xml"
                soapBody="CreateFileVersion" throwException="true" />

            <PutInSessionPipe name="storeCreateFileVersionAction" sessionKey="RequestSoapAction"
                value="http://bct.nl/CreateFileVersion" />

            <SenderPipe name="sendToCorsa4">
                <WebServiceSender sharedResourceRef="SharedHttpSession"
                    url="${corsa.url}" soapAction="http://bct.nl/CreateFileVersion" soap="false"
                    timeout="12500" />
                <Forward name="success" path="CreateFileVersionCheck" />
                <Forward name="exception" path="isErrorXML" />
            </SenderPipe>

            <XmlSwitchPipe
                name="CreateFileVersionCheck"
                xpathExpression="//CreateFileVersionResult = 'true'">
                <Forward name="true" path="RemoveXMLDeclaration" />
                <Forward name="false" path="isErrorXML" />
            </XmlSwitchPipe>

            <XsltPipe name="RemoveXMLDeclaration" omitXmlDeclaration="true"
                handleLexicalEvents="true" styleSheetName="xsl/Response2NoXML.xsl" />

            <SoapWrapperPipe name="WrapResult" removeOutputNamespaces="true"
                storeResultInSessionKey="FileVersionDetails" />

            <XsltPipe name="ConvertToDisconnectRequest" styleSheetName="xsl/Message2Disconnect.xsl" />

            <SoapWrapperPipe name="WrapDisconnectRequest" storeResultInSessionKey="corsaRequest" />

            <WsdlXmlValidatorPipe name="ValidateDisconnectRequest" wsdl="Corsa72WS4j.xml"
                soapBody="Disconnect" throwException="true" />

            <PutInSessionPipe name="storeDisconnectAction" sessionKey="RequestSoapAction"
                value="http://bct.nl/Disconnect" />

            <SenderPipe name="SendDisconnectRequest">
                <WebServiceSender sharedResourceRef="SharedHttpSession"
                    url="${corsa.url}" soapAction="http://bct.nl/Disconnect" soap="false"
                    timeout="12500" />
                <Forward name="success" path="UnwrapDisconnectResponse" />
                <Forward name="exception" path="isErrorXML" />
            </SenderPipe>

            <SoapWrapperPipe name="UnwrapDisconnectResponse" direction="UNWRAP"
                removeOutputNamespaces="true">
                <Forward name="success" path="DisconnectSuccessCheck" />
                <Forward name="exception" path="EXCEPTION" />
            </SoapWrapperPipe>

            <XmlSwitchPipe
                name="DisconnectSuccessCheck"
                xpathExpression="DisconnectResponse/DisconnectResult = 'true'">
                <Forward name="true" path="DateTime2Date" />
                <Forward name="false" path="isErrorXML" />
            </XmlSwitchPipe>

            <XsltPipe name="DateTime2Date" styleSheetName="xsl/DateTime2Date.xsl"
                storeResultInSessionKey="StoreDate">
                <Param name="datetime" xpathExpression="current-dateTime()" />
            </XsltPipe>

            <SenderPipe name="StoreVertrouwelijkheid" getInputFromSessionKey="originalMessage">
                <FixedQuerySender
                    query="INSERT INTO INFO_CACHE VALUES (?, ?, ?, ?, ?) ON CONFLICT DO NOTHING;" />
                <Param name="REGISTRATIENUMMER" sessionKey="DocumentDetails"
                    xpathExpression="//NewObjectID" />
                <Param name="VERTROUWELIJKHEID" xpathExpression="//vertrouwelijkheid" />
                <Param name="AFZENDER" xpathExpression="//behandelaarnaam" />
                <Param name="ONDERWERP" xpathExpression="//onderwerp" />
                <Param name="STOREDATE" sessionKey="StoreDate" />
            </SenderPipe>

            <EchoPipe name="ReturnResult" getInputFromSessionKey="FileVersionDetails">
                <Forward name="success" path="SUCCESS" />
            </EchoPipe>


            <!-- Error Handling -->
            <IsXmlPipe name="isErrorXML">
                <Forward name="then" path="storeErrorResponse" />
                <Forward name="else" path="errorToXML" />
            </IsXmlPipe>

            <Text2XmlPipe xmlTag="error" name="errorToXML"></Text2XmlPipe>

            <PutInSessionPipe name="storeErrorResponse">
                <Param name="corsaResponse" />
                <Forward name="success" path="buildErrorMsg" />
            </PutInSessionPipe>

            <XsltPipe name="buildErrorMsg"
                styleSheetName="xsl/CreateErrorResponse.xsl"
                getInputFromFixedValue="&lt;dummy/&gt;">
                <Param name="corsaRequest" sessionKey="corsaRequest" />
                <Param name="corsaResponse" sessionKey="corsaResponse" />
                <Param name="corsaErrorMessage" xpathExpression="//LastError"
                    sessionKey="corsaResponse" defaultValue="No Error Message" />
                <Param name="soapAction" sessionKey="RequestSoapAction" />
                <Forward name="success" path="EXCEPTION" />
            </XsltPipe>
        </Pipeline>
    </Adapter>


</Module>